<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta charset="utf-8">
    <title>Mastersystem encoder</title>
    <link href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.6/united/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="jumbotron">
    <div class="container text-center"><h1>Master system encoder</h1>
                <p>Blabla.
                </p>
                <img style="height: 350px;" src="Mastersystem.jpg" alt="Tabelle zum Mastersystem">
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-sm-12 col-md-9"><h2>Kodierung einer Zahl im Master-System</h2>

            <div class="well text-center">
                <div class="form-group"><label for="num">Zu kodierende Zahl:</label>

                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control"
                               value="" id="num">

                        <div class="input-group-btn">
                            <button class="btn btn-default btn-lg" onclick="search();"
                                    type="button" id="search" disabled="disabled">Search words
                            </button>
                        </div>
                    </div>
                </div>
                <div class="well" id="quickstartjs">
                    <div class="form-group"><label>Resultat</label>
                        <pre id="result">
hu
ha
                        </pre>
                    </div>
                    <div class="form-group" id="splitresults">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script type="text/javascript">
    var datalocation = "allde.json"; // "somewords.json";
    var words = [];
    var patterns = {
        "0":"(x+|z+|s+(?!ch)|ß+)",
        "1":"([td]+)",
        "2":"([nñ]+)",
        "3":"(m+)",
        "4":"(r+)",
        "5":"(l+)",
        "6":"(sch|ch|j+|g+)",
        "7":"(k+|ck|g+|c+(?!h)|c+(?!h)k+|q+|x+)",
        "8":"(f+|v+|w+|ph)",
        "9":"([pb]+)"
    };

    var result = $("#result");
    var splitresults = $("#splitresults");
    var round = 0;
    var ignorePattern = "([aeiouäöüAEUIOÄÖÜyhéâêà.' -]*)";
    result.text("Einen Moment: Wörter werden geladen...");
    $.getJSON( datalocation, function( data ) {
        words = data;
        $("#search").removeAttr("disabled");
        if (console) console.log("loaded " + words.length + " words." );
        result.text(words.length + " Wörter geladen.");
    });

    var errors;

    function search() {
        errors = "";
        result.text("");
        splitresults.text("");
        round = 0;
        var num = $("#num").val();
        if (console) console.log("Number:" + num);
        var matchingwords = allmatches(num);
        if ("" != errors) {
            result.text(errors);
        } else {
            result.text(matchingwords.join("\n"))
        }

        searchSplits(num, " ");
    }

    // returns (possibly empty) array of matches or undefined, if there are no matches
    function allmatches(num) {
        errors = "";
        var regex = ignorePattern;
        $.each(num.split(""), function(idx, c) {
            var cpattern = patterns[c];
            if (null == cpattern) errors = errors + ("Can't find pattern for " + c + "\n");
            else regex = regex + cpattern + ignorePattern;
        });
        if ("" != errors) return undefined;

        var rxp = new RegExp("^" + regex + "$", "i");
        var matchingwords = [];
        $.each(words, function(idx, word) {
            if(rxp.test(word)) matchingwords.push(word);
        });
        if(console) console.log("found " + matchingwords.length + " words for " + num + " : " + rxp);
        return matchingwords;
    }

    // returns <td><pre>(matches)<pre></td>
    function matchTD(num) {
        var matches = allmatches(num);
        if (matches) return "<td><pre>" + matches.join("\n") + "</pre></td>";
        else return undefined;
    }

    function searchSplits(num, startTDs) {
        if (round > 100) { alert('100 rounds - aborting'); return; }
        round = round + 1;
        if(!num) {
            if(startTDs) {
                var tbl = "<table><tr>" + startTDs + "</tr></table>";
                if(console) console.log(tbl);
                splitresults.append(tbl);
                return;
            }
        }
        for(var i=1; i < num.length; ++i) {
            var contnum = num.substring(0, num.length - i);
            var endnum = num.substring(num.length - i, num.length);
            var contTDs = matchTD(contnum);
            searchSplits(endnum, startTDs + contTDs);
        }
    }
</script>
</body>
</html>
